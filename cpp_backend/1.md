# Backend API Routes Documentation

This document outlines the available API routes for the YouTube Topic Dataset backend.

## 1. Video Management

### `POST /videos`
Adds a new video to the database. If the video already exists, it returns the existing video's information.

-   **Method:** `POST`
-   **Headers:** `Content-Type: application/json`
-   **Body:**
    ```json
    {
        "id": "https://www.youtube.com/watch?v=VIDEO_ID",
        "title": "Optional Video Title"
    }
    ```
-   **Example Request:**
    ```bash
    curl -X POST http://localhost:8000/videos -H "Content-Type: application/json" -d '{"id":"https://www.youtube.com/watch?v=dQw4w9WgXcQ","title":"Major shake-up: China pulls out of its biggest project in Pakistan | Ankit Agrawal Study IQ"}'
    ```
-   **Example Success Response (201 Created):**
    ```json
    {"id":"dQw4w9WgXcQ","title":"Major shake-up: China pulls out of its biggest project in Pakistan | Ankit Agrawal Study IQ"}
    ```
-   **Example Success Response (200 OK, if video already exists):**
    ```json
    {"id":"dQw4w9WgXcQ","title":"Major shake-up: China pulls out of its biggest project in Pakistan | Ankit Agrawal Study IQ"}
    ```
-   **Example Error Response (400 Bad Request):**
    ```json
    {"error":"Video URL is required."}
    ```

## 2. Topic Management

### `GET /videos/:id/topics`
Retrieves all topics associated with a specific video ID, along with their aggregated vote counts.

-   **Method:** `GET`
-   **URL Parameters:** `:id` - The YouTube video ID.
-   **Example Request:**
    ```bash
    curl http://localhost:8000/videos/dQw4w9WgXcQ/topics
    ```
-   **Example Success Response (200 OK):**
    ```json
    {
        "video_id": "dQw4w9WgXcQ",
        "topics": [
            {
                "topic_id": 1,
                "topic_name": "Pakistan",
                "total_votes": 1
            },
            {
                "topic_id": 2,
                "topic_name": "China",
                "total_votes": 1
            }
        ]
    }
    ```
-   **Example Error Response (500 Internal Server Error):**
    ```json
    {"error":"Database error message."}
    ```

### `POST /videos/:id/topics`
Submits a new topic or casts/changes/removes a vote on an existing topic for a given video and user.
This route implements a "one user, one vote per topic" system with toggling functionality.
The `desired_vote` value is clamped: any value > 1 becomes 1, and any value < -1 becomes -1.

-   **Method:** `POST`
-   **URL Parameters:** `:id` - The YouTube video ID.
-   **Headers:** `Content-Type: application/json`
-   **Body:**
    ```json
    {
        "name": "Optional New Topic Name", // Required if topic_id is 0 or not provided
        "topic_id": 0,                     // Required if name is empty (for existing topics)
        "desired_vote": 1,                 // 1 for upvote, -1 for downvote, 0 to remove vote
        "user_id": "user-123"              // Unique identifier for the user (expected from frontend localStorage)
    }
    ```
-   **Behavior:**
    *   If `user_id` is not provided in the request body, a new one will be generated by the backend (fallback).
    *   If `name` is provided and `topic_id` is 0, a new topic will be created if it doesn't exist.
    *   **Voting Logic:**
        *   If the user has no existing vote for this topic/video, a new vote with `desired_vote` (1 or -1) is recorded.
        *   If the user has an existing vote:
            *   If `current_vote == desired_vote` (e.g., user upvoted, then upvoted again), the vote is **removed** (toggled off).
            *   If `current_vote != desired_vote` (e.g., user upvoted, then downvoted), the vote is **updated** to `desired_vote`.
            *   If `desired_vote == 0`, the vote is **removed**.
-   **Example Request (New Topic Upvote):**
    ```bash
    curl -X POST http://localhost:8000/videos/dQw4w9WgXcQ/topics -H "Content-Type: application/json" -d '{"name":"New Economy","desired_vote":1,"user_id":"user-123"}'
    ```
-   **Example Request (Toggle Off Existing Upvote):**
    ```bash
    curl -X POST http://localhost:8000/videos/dQw4w9WgXcQ/topics -H "Content-Type: application/json" -d '{"name":"New Economy","desired_vote":1,"user_id":"user-123"}'
    ```
-   **Example Request (Change Vote from Up to Down):**
    ```bash
    curl -X POST http://localhost:8000/videos/dQw4w9WgXcQ/topics -H "Content-Type: application/json" -d '{"name":"New Economy","desired_vote":-1,"user_id":"user-123"}'
    ```
-   **Example Request (Clamped Vote - `desired_vote:5` becomes `1`):**
    ```bash
    curl -X POST http://localhost:8000/videos/dQw4w9WgXcQ/topics -H "Content-Type: application/json" -d '{"name":"Clamped Topic","desired_vote":5,"user_id":"user-789"}'
    ```
-   **Example Success Response (201 Created):**
    ```json
    {"message":"Vote recorded successfully","user_id":"user-123"}
    ```
-   **Example Success Response (200 OK):**
    ```json
    {"message":"Vote updated successfully","user_id":"user-123"}
    ```
-   **Example Success Response (200 OK, vote removed):**
    ```json
    {"message":"Vote removed successfully","user_id":"user-123"}
    ```
-   **Example Error Response (400 Bad Request):**
    ```json
    {"error":"Desired vote must be 1 (upvote), -1 (downvote), or 0 (no vote)."}
    ```

## 3. Similar Videos

### `GET /videos/:id/similar`
Retrieves videos similar to the given video ID based on shared topics.

-   **Method:** `GET`
-   **URL Parameters:** `:id` - The YouTube video ID.
-   **Example Request:**
    ```bash
    curl http://localhost:8000/videos/dQw4w9WgXcQ/similar
    ```
-   **Example Success Response (200 OK):**
    ```json
    [
        {
            "shared_topics_count": 2,
            "title": "Another Related Video",
            "video_id": "anotherVideoId"
        }
    ]
    ```
-   **Example Error Response (500 Internal Server Error):**
    ```json
    {"error":"Database error message."}
    ```

## 4. User Statistics

### `GET /users/:id/stats`
Retrieves detailed statistics for a specific user.

-   **Method:** `GET`
-   **URL Parameters:** `:id` - The user ID.
-   **Example Request:**
    ```bash
    curl http://localhost:8000/users/user-123/stats
    ```
-   **Example Success Response (200 OK):**
    ```json
    {
        "created_at": "2023-10-27 10:00:00",
        "last_submission_date": "2023-10-27 11:30:00",
        "most_frequent_tag": {
            "topic_count": 5,
            "topic_name": "Technology"
        },
        "reputation": 0,
        "submissions_count": 10,
        "user_id": "user-123",
        "username": null
    }
    ```
-   **Example Error Response (404 Not Found):**
    ```json
    {"error":"User not found."}
    ```
-   **Example Error Response (500 Internal Server Error):**
    ```json
    {"error":"Database error message."}
    ```

### `GET /users/contributions`
Retrieves a list of all users along with their total contribution counts (number of topics submitted/voted on).

-   **Method:** `GET`
-   **Example Request:**
    ```bash
    curl http://localhost:8000/users/contributions
    ```
-   **Example Success Response (200 OK):**
    ```json
    [
        {
            "contributions_count": 3,
            "id": "user-123",
            "username": null
        },
        {
            "contributions_count": 1,
            "id": "user-456",
            "username": null
        }
    ]
    ```
-   **Example Error Response (500 Internal Server Error):**
    ```json
    {"error":"Database error message."}
    ```
